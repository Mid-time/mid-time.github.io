<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>恶魔骰</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            position: relative;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(30, 30, 46, 0.8);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            padding: 20px;
            position: relative;
        }
        
        .help-circle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #7f8c8d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .help-circle:hover {
            background-color: #636e72;
            transform: scale(1.1);
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #394867;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 3rem;
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a5b1c2;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            background-color: #1e1e2e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .player-stats {
            display: flex;
            gap: 30px;
        }
        
        .stat {
            text-align: center;
            position: relative;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4ecdc4;
            transition: all 0.3s ease;
        }
        
        .full-health {
            color: #2ecc71;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.7);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .full-health-label {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #2ecc71;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #a5b1c2;
        }
        
        .round-indicator {
            background-color: #394867;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: #f7f7f7;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .turn-indicator {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .player-turn {
            background-color: rgba(46, 134, 222, 0.3);
            border: 2px solid #2e86de;
            color: #2e86de;
        }
        
        .ai-turn {
            background-color: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }
        
        .game-area {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .player-area, .ai-area {
            flex: 1;
            background-color: rgba(30, 30, 46, 0.7);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .area-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: #a5b1c2;
        }
        
        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .dice {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            background-color: #6c757d;
            border: 3px solid #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            color: #ffffff;
        }
        
        .dice:hover {
            transform: scale(1.05);
        }
        
        .ai-dice {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        
        .current-call {
            background-color: #1e1e2e;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .call-title {
            text-align: center;
            margin-bottom: 10px;
            color: #a5b1c2;
        }
        
        .call-display {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #4ecdc4;
            min-height: 30px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        #open-btn {
            background-color: #e74c3c;
            color: white;
            box-shadow: 0 4px 0 #c0392b;
        }
        
        #open-btn:hover {
            background-color: #c0392b;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #a93226;
        }
        
        #call-btn {
            background-color: #2ecc71;
            color: white;
            box-shadow: 0 4px 0 #27ae60;
        }
        
        #call-btn:hover {
            background-color: #27ae60;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #219653;
        }
        
        #call-btn:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 0 #636e72;
        }
        
        #end-game-btn {
            background-color: #e67e22;
            color: white;
            box-shadow: 0 4px 0 #d35400;
        }
        
        #end-game-btn:hover {
            background-color: #d35400;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #a35200;
        }
        
        .call-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .call-inputs {
            display: flex;
            gap: 10px;
            background-color: #1e1e2e;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .dice-icon {
            font-size: 24px;
            margin-bottom: 5px;
            color: #4ecdc4;
        }
        
        .dice-label {
            font-size: 14px;
            color: #a5b1c2;
            margin-top: 5px;
        }
        
        .call-inputs input {
            width: 60px;
            padding: 10px;
            text-align: center;
            border: 2px solid #394867;
            border-radius: 5px;
            background-color: #2c3e50;
            color: #ecf0f1;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .call-info {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            font-size: 1.1rem;
        }
        
        .call-count, .point-count {
            background-color: #1e1e2e;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .call-count {
            color: #3498db;
        }
        
        .point-count {
            color: #f39c12;
        }
        
        .red {
            color: #e74c3c;
        }
        
        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .win {
            background-color: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
            color: #2ecc71;
        }
        
        .lose {
            background-color: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }
        
        .hidden {
            display: none !important;
        }
        
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .rules-content {
            background-color: #1e1e2e;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .rules-content h2 {
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .rules-content p {
            margin-bottom: 15px;
        }
        
        .rules-content ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }
        
        .rules-content li {
            margin-bottom: 10px;
        }
        
        .close-btn {
            background-color: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin: 20px auto 0;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }
        
        .dice-face {
            display: inline-block;
            margin: 0 5px;
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .call-section {
                flex-direction: column;
            }
            
            .call-inputs {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .help-circle {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="help-circle" id="help-btn">?</div>
    
    <div class="container">
        <header>
            <h1>恶魔骰</h1>
            <div class="subtitle">心理与运气的终极对决</div>
        </header>
        
        <div class="game-info">
            <div class="player-stats">
                <div class="stat">
                    <div class="stat-value" id="health-value">20</div>
                    <div class="stat-label">生命值</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="score-value">0</div>
                    <div class="stat-label">得分</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="round-value">1</div>
                    <div class="stat-label">轮次</div>
                </div>
            </div>
            <div class="round-indicator">
                <span>最高得分: <span id="high-score">0</span></span>
                <span>最长轮次: <span id="max-round">0</span></span>
            </div>
        </div>
        
        <div id="turn-indicator" class="turn-indicator player-turn">
            玩家回合
        </div>
        
        <div class="game-area">
            <div class="player-area">
                <h2 class="area-title">你的骰子</h2>
                <div id="player-dice" class="dice-container"></div>
            </div>
            
            <div class="ai-area">
                <h2 class="area-title">恶魔的骰子</h2>
                <div id="ai-dice" class="dice-container"></div>
            </div>
        </div>
        
        <div class="current-call">
            <h3 class="call-title">当前叫骰</h3>
            <div id="current-call-display" class="call-display">暂无叫骰</div>
        </div>
        
        <div class="controls">
            <button id="open-btn">开！</button>
            <div class="call-section">
                <button id="call-btn">叫！</button>
                <div class="call-inputs">
                    <div class="input-group">
                        <div class="dice-icon">2</div>
                        <input type="number" min="0" id="dice-2" value="0">
                        <div class="dice-label">2点</div>
                    </div>
                    <div class="input-group">
                        <div class="dice-icon">3</div>
                        <input type="number" min="0" id="dice-3" value="0">
                        <div class="dice-label">3点</div>
                    </div>
                    <div class="input-group">
                        <div class="dice-icon">4</div>
                        <input type="number" min="0" id="dice-4" value="0">
                        <div class="dice-label">4点</div>
                    </div>
                    <div class="input-group">
                        <div class="dice-icon">5</div>
                        <input type="number" min="0" id="dice-5" value="0">
                        <div class="dice-label">5点</div>
                    </div>
                    <div class="input-group">
                        <div class="dice-icon">6</div>
                        <input type="number" min="0" id="dice-6" value="0">
                        <div class="dice-label">6点</div>
                    </div>
                </div>
            </div>
            <button id="end-game-btn">结束游戏</button>
        </div>
        
        <div class="call-info">
            <div class="call-count">叫骰数量: <span id="call-count-value">0</span></div>
            <div class="point-count">点数数量: <span id="point-count-value">0</span></div>
        </div>
        
        <div id="result" class="result hidden"></div>
    </div>
    
    <div id="rules-modal" class="rules-modal hidden">
        <div class="rules-content">
            <h2>恶魔骰游戏规则</h2>
            <p>欢迎来到恶魔骰，这是一场心理与运气的终极对决！</p>
            
            <h3>游戏目标</h3>
            <p>通过叫骰和开骰与恶魔对决，尽可能获得高分并存活更多轮次。</p>
            
            <h3>游戏规则</h3>
            <ul>
                <li>你和恶魔各有5个骰子，你可以看到自己的骰子，但看不到恶魔的骰子</li>
                <li>每回合，你可以选择"叫骰"或"开骰"</li>
                <li>叫骰时，你需要指定不同点数的骰子数量（如2个3点，3个6点等）</li>
                <li>每次叫骰必须比上一次叫骰数量更多，或数量相同但点数更多</li>
                <li>如果你认为恶魔的叫骰不可能存在，可以选择"开骰"</li>
                <li>开骰后，双方所有骰子公开，验证叫骰是否成立</li>
                <li>点数1的骰子是万能骰子，可以当作任何点数使用</li>
            </ul>
            
            <h3>得分与生命</h3>
            <ul>
                <li>初始生命值：20点</li>
                <li>获胜时：得分 += 骰子数量 × 骰子点数 ÷ 2（向下取整）</li>
                <li>获胜时：恢复生命值 += 骰子数量 ÷ 3（向下取整）</li>
                <li>失败时：扣除生命值 = 骰子数量</li>
                <li>生命值归零时游戏结束</li>
            </ul>
            
            <button id="close-rules-btn" class="close-btn">关闭</button>
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            playerDice: [],
            aiDice: [],
            currentCall: null,
            gameOver: false,
            round: 1,
            playerHealth: 20,
            playerScore: 0,
            isPlayerTurn: true,
            highScore: 0,
            maxRound: 0
        };

        // DOM元素
        const playerDiceContainer = document.getElementById('player-dice');
        const aiDiceContainer = document.getElementById('ai-dice');
        const openBtn = document.getElementById('open-btn');
        const callBtn = document.getElementById('call-btn');
        const endGameBtn = document.getElementById('end-game-btn');
        const helpBtn = document.getElementById('help-btn');
        const diceInputs = [
            document.getElementById('dice-2'),
            document.getElementById('dice-3'),
            document.getElementById('dice-4'),
            document.getElementById('dice-5'),
            document.getElementById('dice-6')
        ];
        const callCountValue = document.getElementById('call-count-value');
        const pointCountValue = document.getElementById('point-count-value');
        const resultDiv = document.getElementById('result');
        const currentCallDisplay = document.getElementById('current-call-display');
        const turnIndicator = document.getElementById('turn-indicator');
        const healthValue = document.getElementById('health-value');
        const scoreValue = document.getElementById('score-value');
        const roundValue = document.getElementById('round-value');
        const highScoreElement = document.getElementById('high-score');
        const maxRoundElement = document.getElementById('max-round');
        const rulesModal = document.getElementById('rules-modal');
        const closeRulesBtn = document.getElementById('close-rules-btn');

        // 骰子面表示 - 修改为数字和骷髅头
        const diceFaces = {
            1: '☠', // 骷髅头
            2: '2',
            3: '3',
            4: '4',
            5: '5',
            6: '6'
        };

        // 显示游戏规则
        function showRules() {
            console.log('显示规则弹窗');
            rulesModal.classList.remove('hidden');
        }

        // 隐藏游戏规则
        function hideRules() {
            console.log('隐藏规则弹窗');
            rulesModal.classList.add('hidden');
        }

        // 更新满血状态显示
        function updateFullHealthDisplay() {
            const healthStat = document.querySelector('.stat:first-child');
            const existingLabel = healthStat.querySelector('.full-health-label');
            
            // 移除现有标签
            if (existingLabel) {
                existingLabel.remove();
            }
            
            // 更新样式
            if (gameState.playerHealth >= 20) {
                healthValue.classList.add('full-health');
                
                // 添加满血标签
                const fullHealthLabel = document.createElement('span');
                fullHealthLabel.className = 'full-health-label';
                fullHealthLabel.textContent = '满血';
                healthStat.appendChild(fullHealthLabel);
            } else {
                healthValue.classList.remove('full-health');
            }
        }

        // 初始化游戏
        function initGame() {
            // 从本地存储加载数据
            loadGameData();
            
            // 重置游戏状态
            gameState.playerDice = rollDice(5);
            gameState.aiDice = rollDice(5);
            gameState.currentCall = null;
            gameState.gameOver = false;
            gameState.isPlayerTurn = true;
            
            // 更新UI
            updateDiceDisplay();
            updateCallInfo();
            updatePlayerStats();
            updateTurnIndicator();
            resultDiv.classList.add('hidden');
            currentCallDisplay.textContent = "暂无叫骰";
            
            // 如果玩家生命值为0，重置生命值
            if (gameState.playerHealth <= 0) {
                gameState.playerHealth = 20;
                gameState.playerScore = 0;
                gameState.round = 1;
                updatePlayerStats();
            }
            
            // 更新满血显示
            updateFullHealthDisplay();
        }

        // 从本地存储加载游戏数据
        function loadGameData() {
            const savedData = localStorage.getItem('demonDiceGame');
            if (savedData) {
                const data = JSON.parse(savedData);
                gameState.highScore = data.highScore || 0;
                gameState.maxRound = data.maxRound || 0;
                
                highScoreElement.textContent = gameState.highScore;
                maxRoundElement.textContent = gameState.maxRound;
            }
        }

        // 保存游戏数据到本地存储
        function saveGameData() {
            const data = {
                highScore: gameState.highScore,
                maxRound: gameState.maxRound
            };
            localStorage.setItem('demonDiceGame', JSON.stringify(data));
        }

        // 掷骰子
        function rollDice(count) {
            const dice = [];
            for (let i = 0; i < count; i++) {
                dice.push(Math.floor(Math.random() * 6) + 1);
            }
            return dice;
        }

        // 更新骰子显示
        function updateDiceDisplay() {
            // 玩家骰子
            playerDiceContainer.innerHTML = '';
            gameState.playerDice.forEach(value => {
                const diceEl = document.createElement('div');
                diceEl.className = 'dice';
                diceEl.textContent = diceFaces[value];
                playerDiceContainer.appendChild(diceEl);
            });
            
            // AI骰子 - 初始隐藏
            aiDiceContainer.innerHTML = '';
            gameState.aiDice.forEach(value => {
                const diceEl = document.createElement('div');
                diceEl.className = 'dice ai-dice';
                diceEl.textContent = '?';
                aiDiceContainer.appendChild(diceEl);
            });
        }

        // 显示AI骰子
        function revealAiDice() {
            aiDiceContainer.innerHTML = '';
            gameState.aiDice.forEach(value => {
                const diceEl = document.createElement('div');
                diceEl.className = 'dice';
                diceEl.textContent = diceFaces[value];
                aiDiceContainer.appendChild(diceEl);
            });
        }

        // 更新玩家状态
        function updatePlayerStats() {
            healthValue.textContent = gameState.playerHealth;
            scoreValue.textContent = gameState.playerScore;
            roundValue.textContent = gameState.round;
            
            // 更新满血显示
            updateFullHealthDisplay();
        }

        // 更新回合指示器
        function updateTurnIndicator() {
            if (gameState.isPlayerTurn) {
                turnIndicator.textContent = "玩家回合";
                turnIndicator.className = "turn-indicator player-turn";
            } else {
                turnIndicator.textContent = "恶魔回合";
                turnIndicator.className = "turn-indicator ai-turn";
            }
        }

        // 更新叫骰信息
        function updateCallInfo() {
            let callCount = 0;
            let pointCount = 0;
            const callArray = [];
            
            diceInputs.forEach((input, index) => {
                const value = parseInt(input.value) || 0;
                callCount += value;
                pointCount += value * (index + 2); // 点数从2到6
                callArray.push(value);
            });
            
            callCountValue.textContent = callCount;
            pointCountValue.textContent = pointCount;
            
            // 验证叫骰是否有效
            const isValid = validateCall(callCount, pointCount, callArray);
            
            // 更新UI
            callCountValue.className = isValid ? '' : 'red';
            pointCountValue.className = isValid ? '' : 'red';
            callBtn.disabled = !isValid;
        }

        // 验证叫骰是否有效
        function validateCall(callCount, pointCount, callArray) {
            // 第一次叫骰必须至少有一个骰子
            if (gameState.currentCall === null) {
                return callCount > 0;
            }
            
            // 叫骰数量必须比上一次多，或者数量相同但点数更多
            if (callCount > gameState.currentCall.count) {
                return true;
            } else if (callCount === gameState.currentCall.count) {
                return pointCount > gameState.currentCall.points;
            }
            
            return false;
        }

        // 玩家叫骰
        function playerCall() {
            const callCount = parseInt(callCountValue.textContent);
            const pointCount = parseInt(pointCountValue.textContent);
            const callArray = [];
            
            diceInputs.forEach(input => {
                callArray.push(parseInt(input.value) || 0);
            });
            
            // 更新当前叫骰
            gameState.currentCall = { 
                count: callCount, 
                points: pointCount,
                callArray: callArray
            };
            
            // 重置输入框
            diceInputs.forEach(input => {
                input.value = '0';
            });
            
            updateCallInfo();
            updateCallDisplay();
            
            // AI回合
            aiCall();
        }

        // 更新叫骰显示
        function updateCallDisplay() {
            const call = gameState.currentCall;
            if (!call) return;
            
            let displayText = "";
            for (let i = 0; i < call.callArray.length; i++) {
                if (call.callArray[i] > 0) {
                    if (displayText !== "") displayText += " + ";
                    displayText += `${call.callArray[i]}个${i+2}点`;
                }
            }
            displayText += ` (总数:${call.count}, 点数:${call.points})`;
            
            currentCallDisplay.textContent = displayText;
        }

        // AI叫骰算法
        function aiCall() {
            // 更新回合指示器
            gameState.isPlayerTurn = false;
            updateTurnIndicator();
            
            // 延迟执行，增加思考时间
            setTimeout(() => {
                // 如果这是第一轮，AI需要先叫骰
                if (gameState.currentCall === null) {
                    // 第一轮AI会基于自己的骰子叫一个合理的骰子
                    const aiDiceCounts = [0, 0, 0, 0, 0, 0, 0];
                    gameState.aiDice.forEach(value => {
                        aiDiceCounts[value]++;
                    });
                    
                    // 找到AI最多的点数（除了1）
                    let maxPoint = 2;
                    let maxCount = aiDiceCounts[2];
                    for (let i = 3; i <= 6; i++) {
                        if (aiDiceCounts[i] > maxCount) {
                            maxCount = aiDiceCounts[i];
                            maxPoint = i;
                        }
                    }
                    
                    // 计算叫骰数量（自己的数量+1，考虑玩家可能有）
                    const callCount = maxCount + 1;
                    const callArray = [0, 0, 0, 0, 0];
                    callArray[maxPoint - 2] = callCount;
                    
                    // 设置当前叫骰
                    gameState.currentCall = {
                        count: callCount,
                        points: callCount * maxPoint,
                        callArray: callArray
                    };
                    
                    // 更新UI
                    updateCallDisplay();
                    
                    // 切换回玩家回合
                    setTimeout(() => {
                        gameState.isPlayerTurn = true;
                        updateTurnIndicator();
                    }, 1500);
                    
                    return;
                }
                
                // 简化版AI逻辑 - 总是增加叫骰数量
                const currentCall = gameState.currentCall;
                const newCount = currentCall.count + 1;
                const newCallArray = [...currentCall.callArray];
                
                // 找到第一个非零点数并增加其数量
                for (let i = 0; i < newCallArray.length; i++) {
                    if (newCallArray[i] > 0) {
                        newCallArray[i] = newCount;
                        break;
                    }
                }
                
                // 如果没有找到非零点数，默认增加第一个点数
                if (newCallArray.every(val => val === 0)) {
                    newCallArray[0] = newCount;
                }
                
                const newPoints = calculatePoints(newCallArray);
                
                // 更新当前叫骰
                gameState.currentCall = {
                    count: newCount,
                    points: newPoints,
                    callArray: newCallArray
                };
                
                // 更新UI
                updateCallDisplay();
                
                // 切换回玩家回合
                setTimeout(() => {
                    gameState.isPlayerTurn = true;
                    updateTurnIndicator();
                }, 1500);
            }, 2000); // 2秒思考时间
        }

        // 计算叫骰数组的总点数
        function calculatePoints(callArray) {
            let points = 0;
            for (let i = 0; i < callArray.length; i++) {
                points += callArray[i] * (i + 2);
            }
            return points;
        }

        // 开骰
        function openDice(isAiOpening = false) {
            // 显示所有骰子
            revealAiDice();
            
            // 统计所有骰子
            const allDice = [...gameState.playerDice, ...gameState.aiDice];
            const diceCounts = [0, 0, 0, 0, 0, 0, 0]; // 索引0不使用，索引1-6对应点数1-6
            
            allDice.forEach(value => {
                diceCounts[value]++;
            });
            
            // 计算实际存在的骰子数量（包括万能骰子1）
            let actualCount = 0;
            const callArray = gameState.currentCall.callArray;
            
            for (let i = 0; i < callArray.length; i++) {
                const point = i + 2;
                const required = callArray[i];
                
                if (required > 0) {
                    // 实际有这个点数的骰子数量
                    const actualForPoint = diceCounts[point];
                    // 加上万能骰子（点数1）
                    const actualWithWild = actualForPoint + diceCounts[1];
                    
                    // 这个点数的骰子实际存在数量
                    actualCount += Math.min(required, actualWithWild);
                    
                    // 更新万能骰子数量（被使用后减少）
                    diceCounts[1] = Math.max(0, diceCounts[1] - Math.max(0, required - actualForPoint));
                }
            }
            
            // 比较结果
            const isCallValid = actualCount >= gameState.currentCall.count;
            
            // 显示结果
            resultDiv.classList.remove('hidden');
            
            // 计算奖励/惩罚
            const diceCount = gameState.currentCall.count;
            const dicePoints = gameState.currentCall.points;
            
            if (isAiOpening) {
                // AI开骰
                if (isCallValid) {
                    resultDiv.textContent = "恶魔开骰成功，你输了！";
                    resultDiv.className = "result lose";
                    
                    // 玩家失败，扣除生命值
                    gameState.playerHealth -= diceCount;
                    if (gameState.playerHealth < 0) gameState.playerHealth = 0;
                } else {
                    resultDiv.textContent = "恶魔开骰失败，你赢了！";
                    resultDiv.className = "result win";
                    
                    // 玩家获胜，获得分数和恢复生命值
                    const scoreGain = Math.floor(diceCount * dicePoints / 2);
                    const healthGain = Math.floor(diceCount / 3);
                    
                    gameState.playerScore += scoreGain;
                    gameState.playerHealth += healthGain;
                    
                    // 血量上限为20
                    if (gameState.playerHealth > 20) {
                        gameState.playerHealth = 20;
                    }
                    
                    resultDiv.innerHTML += `<br>获得 ${scoreGain} 分，恢复 ${healthGain} 点生命值`;
                }
            } else {
                // 玩家开骰
                if (isCallValid) {
                    resultDiv.textContent = "你开骰失败，你输了！";
                    resultDiv.className = "result lose";
                    
                    // 玩家失败，扣除生命值
                    gameState.playerHealth -= diceCount;
                    if (gameState.playerHealth < 0) gameState.playerHealth = 0;
                } else {
                    resultDiv.textContent = "你开骰成功，你赢了！";
                    resultDiv.className = "result win";
                    
                    // 玩家获胜，获得分数和恢复生命值
                    const scoreGain = Math.floor(diceCount * dicePoints / 2);
                    const healthGain = Math.floor(diceCount / 3);
                    
                    gameState.playerScore += scoreGain;
                    gameState.playerHealth += healthGain;
                    
                    // 血量上限为20
                    if (gameState.playerHealth > 20) {
                        gameState.playerHealth = 20;
                    }
                    
                    resultDiv.innerHTML += `<br>获得 ${scoreGain} 分，恢复 ${healthGain} 点生命值`;
                }
            }
            
            // 更新最高得分和最长轮次
            if (gameState.playerScore > gameState.highScore) {
                gameState.highScore = gameState.playerScore;
                highScoreElement.textContent = gameState.highScore;
            }
            
            if (gameState.round > gameState.maxRound) {
                gameState.maxRound = gameState.round;
                maxRoundElement.textContent = gameState.maxRound;
            }
            
            // 保存游戏数据
            saveGameData();
            
            gameState.gameOver = true;
            
            // 添加重新开始按钮
            const restartBtn = document.createElement('button');
            restartBtn.textContent = '再来一局';
            restartBtn.style.marginTop = '10px';
            restartBtn.onclick = () => {
                gameState.round++;
                initGame();
            };
            resultDiv.appendChild(restartBtn);
            
            // 更新玩家状态
            updatePlayerStats();
        }

        // 强制结束游戏
        function endGame() {
            if (confirm("确定要结束当前游戏吗？这将记录当前进度并重新开始游戏。")) {
                // 更新最高得分和最长轮次
                if (gameState.playerScore > gameState.highScore) {
                    gameState.highScore = gameState.playerScore;
                    highScoreElement.textContent = gameState.highScore;
                }
                
                if (gameState.round > gameState.maxRound) {
                    gameState.maxRound = gameState.round;
                    maxRoundElement.textContent = gameState.maxRound;
                }
                
                // 保存游戏数据
                saveGameData();
                
                // 显示所有骰子
                revealAiDice();
                
                // 显示结果
                resultDiv.classList.remove('hidden');
                resultDiv.textContent = "游戏已结束！";
                resultDiv.className = "result";
                resultDiv.innerHTML += `<br>本轮得分: ${gameState.playerScore}，轮次: ${gameState.round}`;
                
                // 添加重新开始按钮
                const restartBtn = document.createElement('button');
                restartBtn.textContent = '重新开始';
                restartBtn.style.marginTop = '10px';
                restartBtn.onclick = () => {
                    gameState.playerHealth = 20;
                    gameState.playerScore = 0;
                    gameState.round = 1;
                    initGame();
                };
                resultDiv.appendChild(restartBtn);
                
                gameState.gameOver = true;
            }
        }

        // 初始化事件监听器
        function initEventListeners() {
            console.log('初始化事件监听器');
            
            openBtn.addEventListener('click', () => {
                if (!gameState.gameOver && gameState.currentCall) {
                    openDice(false);
                }
            });

            callBtn.addEventListener('click', () => {
                if (!gameState.gameOver) {
                    playerCall();
                }
            });

            endGameBtn.addEventListener('click', endGame);

            helpBtn.addEventListener('click', showRules);

            // 修复：确保关闭按钮正确绑定事件
            closeRulesBtn.addEventListener('click', hideRules);

            // 添加点击模态框背景关闭功能
            rulesModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideRules();
                }
            });

            diceInputs.forEach(input => {
                input.addEventListener('input', updateCallInfo);
            });
        }

        // 初始化游戏
        function startGame() {
            console.log('开始游戏初始化');
            initEventListeners();
            initGame();
        }

        // 页面加载完成后启动游戏
        document.addEventListener('DOMContentLoaded', startGame);
        
        // 全局函数，可以在控制台调用
        window.hideRules = hideRules;
        window.showRules = showRules;
    </script>
</body>
</html>