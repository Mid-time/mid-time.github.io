<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>战斗轮视图</title>
    <style>
        /* 基础样式保持不变 */
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --light-color: #f5f7fa;
            --dark-color: #2c3e50;
            --success-color: #5cb85c;
            --danger-color: #d9534f;
            --warning-color: #f0ad4e;
            --hp-color: #e74c3c;
            --mp-color: #3498db;
            --sanity-color: #f39c12;
            --speed-color: #ff9800;
            --reason-color: #2196F3;
            --stamina-color: #8a2be2;
            --team1-color: #4a6fa5;
            --team2-color: #d9534f;
            --positive-color: #2196F3; /* 正面 - 蓝色 */
            --negative-color: #9C27B0; /* 负面 - 紫色 */
            --greater-color: #4CAF50;  /* 大于 - 绿色 */
            --less-color: #F44336;     /* 小于 - 红色 */
            --equal-color: #FFC107;    /* 等于 - 黄色 */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .round-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 0;
        }
        
        .round-input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .description {
            color: var(--dark-color);
            opacity: 0.8;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        /* 行动栏样式 */
        .action-bar {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .action-bar-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .action-bar-characters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .action-character {
            background-color: var(--light-color);
            border-radius: 6px;
            padding: 6px 8px;
            min-width: 80px;
            max-width: 100px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 70px;
            justify-content: space-between;
        }
        
        .action-character.slow-speed {
            opacity: 0.6;
            filter: grayscale(0.5);
        }
        
        .action-character:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        
        .action-character-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        
        .action-character-speed {
            color: var(--speed-color);
            font-weight: bold;
            font-size: 0.9rem;
            background-color: rgba(255, 152, 0, 0.1);
            border-radius: 4px;
            padding: 2px 4px;
            min-width: 20px;
            text-align: center;
        }
        
        .action-character-team {
            font-size: 0.65rem;
            color: #666;
            padding: 2px 4px;
            border-radius: 10px;
            display: inline-block;
            max-width: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .team1-indicator {
            background-color: rgba(74, 111, 165, 0.1);
            color: var(--team1-color);
        }
        
        .team2-indicator {
            background-color: rgba(217, 83, 79, 0.1);
            color: var(--team2-color);
        }
        
        .action-character-name {
            font-weight: 600;
            font-size: 0.8rem;
            line-height: 1.2;
            margin-top: auto;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .teams-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .team {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            position: relative;
        }
        
        .team:hover {
            transform: translateY(-5px);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .team-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            cursor: pointer;
        }
        
        .team-actions {
            display: flex;
            gap: 5px;
        }
        
        .team-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }
        
        .character-list {
            min-height: 200px;
            position: relative;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
            gap: 15px;
        }
        
        .character {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .character:hover {
            background-color: #e8ecf1;
        }
        
        /* 角色卡片布局 */
        .character-top-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .character-speed, .character-reason {
            font-weight: bold;
            font-size: 0.9rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .character-speed {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--speed-color);
        }
        
        .character-reason {
            background-color: rgba(33, 150, 243, 0.1);
            color: var(--reason-color);
        }
        
        .character-name {
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.95rem;
            line-height: 1.2;
            padding: 4px 0;
        }
        
        .character-middle-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        
        .character-sanity {
            color: var(--sanity-color);
            font-weight: bold;
        }
        
        .character-hp {
            color: var(--hp-color);
            font-weight: bold;
        }
        
        .character-mp {
            color: var(--mp-color);
            font-weight: bold;
        }
        
        .hp-stamina-value {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .stamina-plus {
            color: var(--stamina-color);
            font-weight: bold;
        }
        
        .character-bars {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .hp-stamina-container {
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .hp-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s;
            background-color: var(--hp-color);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }
        
        .stamina-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s;
            background-color: var(--stamina-color);
            position: absolute;
            top: 0;
            z-index: 1;
        }
        
        .dual-bars {
            display: flex;
            gap: 5px;
        }
        
        .dual-bar-container {
            flex: 1;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .stat-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .sanity-bar {
            background-color: var(--sanity-color);
        }
        
        .mp-bar {
            background-color: var(--mp-color);
        }
        
        .character-effect {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 8px;
            min-height: 16px;
        }
        
        .character-actions-panel {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: none;
            flex-direction: row;
            gap: 5px;
            width: auto;
            margin-top: 5px;
        }
        
        .character-actions-panel button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            width: 36px;
            height: 36px;
        }
        
        .edit-character-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .move-character-btn {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .delete-character-btn {
            background-color: var(--danger-color);
            color: white;
        }
        
        .close-panel-btn {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .character-actions-panel button:hover {
            opacity: 0.9;
        }
        
        .dragging {
            opacity: 0.7;
            z-index: 1000;
            position: relative;
            transform: rotate(5deg);
        }
        
        .drop-target {
            background-color: rgba(74, 111, 165, 0.1);
            border: 2px dashed var(--primary-color);
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
            grid-column: 1 / -1;
        }
        
        /* 批量操作样式 */
        .batch-controls {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .batch-controls.active {
            display: flex;
        }
        
        .batch-selection-count {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .batch-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .batch-action-btn {
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .batch-action-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .batch-cancel-btn {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .batch-cancel-btn:hover {
            background-color: #d0d0d0;
        }
        
        .character-checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 18px;
            height: 18px;
            z-index: 10;
            display: none;
        }
        
        .batch-mode .character-checkbox {
            display: block;
        }
        
        .batch-mode .character {
            padding-top: 25px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .danger-btn {
            background-color: var(--danger-color);
        }
        
        .danger-btn:hover {
            background-color: #c9302c;
        }
        
        /* 骰池部分样式 - 优化后 */
        .dice-pool-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .dice-pool-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .dice-pool-item {
            margin-bottom: 15px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            position: relative;
        }
        
        .dice-pool-header {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .dice-type-selector {
            flex: 1;
            min-width: 120px;
        }
        
        .dice-type-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        .dice-note {
            flex: 2;
            min-width: 150px;
        }
        
        .dice-note input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .delete-dice-pool {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
        }
        
        .dice-pool-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .dice-control-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .sanity-effect-selector {
            min-width: 100px;
        }
        
        .sanity-effect-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        .dice-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dice-input input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .dice-input.small input {
            width: 50px;
        }
        
        .dice-input.medium input {
            width: 70px;
        }
        
        .expression-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .expression-input input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .generate-dice {
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .generate-dice:hover {
            background-color: var(--secondary-color);
        }
        
        .dice-results {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .dice-result {
            background-color: var(--light-color);
            border-radius: 4px;
            padding: 8px 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 骰子结果样式 */
        .positive-result {
            border: 2px solid var(--positive-color);
        }
        
        .negative-result {
            border: 2px solid var(--negative-color);
        }
        
        .greater-result {
            border: 2px solid var(--greater-color);
        }
        
        .less-result {
            border: 2px solid var(--less-color);
        }
        
        .equal-result {
            border: 2px solid var(--equal-color);
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .short-input {
            width: 80px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* 批量移动模态框中的下拉框样式 */
        .batch-move-select {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .teams-container {
                flex-direction: column;
            }
            
            .team {
                min-width: 100%;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .character-list {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .character-actions-panel {
                position: fixed;
                top: auto;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
                width: auto;
                max-width: 300px;
            }
            
            .action-bar-characters {
                padding-bottom: 15px;
            }
            
            .action-character {
                min-width: 70px;
                padding: 5px 6px;
            }
            
            .batch-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .batch-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .batch-action-btn {
                flex: 1;
                text-align: center;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .short-input {
                width: 100%;
            }
            
            .dice-pool-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dice-pool-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        /* 移动端优化 */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .character-list {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .character {
                padding: 10px;
            }
            
            .action-character {
                min-width: 65px;
                padding: 4px 5px;
            }
            
            .character-name {
                font-size: 0.85rem;
            }
            
            button {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .batch-action-btn {
                padding: 10px 12px;
            }
        }
        
        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .character {
                padding: 15px;
            }
            
            .character-actions-panel button {
                width: 44px;
                height: 44px;
                font-size: 1.2rem;
            }
            
            .character-checkbox {
                width: 22px;
                height: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="round-header">
                <h1>第</h1>
                <input type="number" class="round-input" id="round-input" value="1" min="1">
                <h1>轮</h1>
            </div>
            <p class="description">powered by Mid</p>
        </header>
        
        <!-- 行动栏 -->
        <div class="action-bar">
            <div class="action-bar-title">
                <span>行动顺序</span>
                <span>（左侧速度最快）</span>
            </div>
            <div class="action-bar-characters" id="action-bar-characters">
                <!-- 行动顺序角色将在这里显示 -->
            </div>
        </div>
        
        <!-- 批量操作控制栏 -->
        <div class="batch-controls" id="batch-controls">
            <div class="batch-selection-count" id="batch-selection-count">已选择 0 个角色</div>
            <div class="batch-actions">
                <button class="batch-action-btn" id="batch-move-btn">移动到队伍</button>
                <button class="batch-action-btn" id="batch-delete-btn">删除选中</button>
                <button class="batch-action-btn batch-cancel-btn" id="batch-cancel-btn">取消批量操作</button>
            </div>
        </div>
        
        <div class="teams-container">
            <div class="team" id="team1">
                <div class="team-header">
                    <div class="team-title" data-team-id="team1">友方</div>
                </div>
                <div class="character-list" id="team1-characters">
                    <div class="empty-state">点击下方按钮添加角色</div>
                </div>
            </div>
            
            <div class="team" id="team2">
                <div class="team-header">
                    <div class="team-title" data-team-id="team2">敌方</div>
                </div>
                <div class="character-list" id="team2-characters">
                    <div class="empty-state">点击下方按钮添加角色</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="new-team-btn">新建队伍</button>
            <button id="new-character-btn">新建角色</button>
            <button id="batch-mode-btn">批量操作</button>
            <button id="add-dice-pool">添加骰池</button>
            <button id="clear-all-btn" class="danger-btn">一键清除</button>
        </div>
        
        <!-- 骰池部分 -->
        <div class="dice-pool-section">
            <h3 class="dice-pool-title">骰子池</h3>
            <div id="dice-pools">
                <!-- 骰池将在这里显示 -->
            </div>
        </div>
    </div>
    
    <!-- 新建/编辑角色模态框 -->
    <div class="modal" id="character-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="character-modal-title">新建角色</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="character-form">
                <input type="hidden" id="character-id">
                <div class="form-group">
                    <label for="character-name">角色名称</label>
                    <input type="text" id="character-name" placeholder="实体">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="character-speed">速度</label>
                        <input type="number" id="character-speed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="character-reason">理智</label>
                        <input type="number" id="character-reason" value="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="character-stamina">耐久</label>
                        <input type="number" id="character-stamina" min="0" value="0" class="short-input">
                    </div>
                    <div class="form-group">
                        <label for="character-hp">当前体力</label>
                        <input type="number" id="character-hp" min="0" value="0" class="short-input">
                    </div>
                    <div class="form-group">
                        <label for="character-hp-max">体力上限</label>
                        <input type="number" id="character-hp-max" min="0" value="0" class="short-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="character-mp">当前魔力</label>
                        <input type="number" id="character-mp" min="0" value="0" class="short-input">
                    </div>
                    <div class="form-group">
                        <label for="character-mp-max">魔力上限</label>
                        <input type="number" id="character-mp-max" min="0" value="0" class="short-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="character-sanity">当前清醒</label>
                        <input type="number" id="character-sanity" min="0" value="0" class="short-input">
                    </div>
                    <div class="form-group">
                        <label for="character-sanity-max">清醒上限</label>
                        <input type="number" id="character-sanity-max" min="0" value="0" class="short-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="character-effect">状态效果</label>
                    <input type="text" id="character-effect" placeholder="例如: 中毒, 流血, 强化">
                </div>
                
                <div class="form-group">
                    <label for="character-description">其他描述</label>
                    <textarea id="character-description" rows="3"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="cancel-btn">取消</button>
                    <button type="submit">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 新建/编辑队伍模态框 -->
    <div class="modal" id="team-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="team-modal-title">新建队伍</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="team-form">
                <input type="hidden" id="team-id">
                <div class="form-group">
                    <label for="team-name">队伍名称</label>
                    <input type="text" id="team-name" placeholder="队伍3">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="cancel-btn">取消</button>
                    <button type="submit">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 批量移动队伍选择模态框 -->
    <div class="modal" id="batch-move-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">选择目标队伍</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="target-team-select">目标队伍</label>
                <select id="target-team-select" class="batch-move-select">
                    <!-- 选项将通过JavaScript动态添加 -->
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel-btn">取消</button>
                <button type="button" id="confirm-batch-move-btn">确认移动</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化数据
        let teams = [
            { id: 'team1', name: '友方', characters: [] },
            { id: 'team2', name: '敌方', characters: [] }
        ];
        
        let characters = [];
        let nextCharacterId = 1;
        let nextTeamId = 3;
        let dragCharacter = null;
        let editingCharacter = null;
        let editingTeam = null;
        let dicePools = [];
        let activeCharacterPanel = null;
        let batchMode = false;
        let selectedCharacters = new Set();
        let longPressTimer = null;
        let dragThreshold = 10; // 拖动阈值，防止误触
        let isMovingFromPanel = false; // 标记是否从控制栏启动移动
        
        // DOM元素
        const characterModal = document.getElementById('character-modal');
        const teamModal = document.getElementById('team-modal');
        const batchMoveModal = document.getElementById('batch-move-modal');
        const characterForm = document.getElementById('character-form');
        const teamForm = document.getElementById('team-form');
        const newCharacterBtn = document.getElementById('new-character-btn');
        const newTeamBtn = document.getElementById('new-team-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const closeModalBtns = document.querySelectorAll('.close-modal, .cancel-btn');
        const roundInput = document.getElementById('round-input');
        const addDicePoolBtn = document.getElementById('add-dice-pool');
        const dicePoolsContainer = document.getElementById('dice-pools');
        const actionBarCharacters = document.getElementById('action-bar-characters');
        const batchModeBtn = document.getElementById('batch-mode-btn');
        const batchControls = document.getElementById('batch-controls');
        const batchSelectionCount = document.getElementById('batch-selection-count');
        const batchMoveBtn = document.getElementById('batch-move-btn');
        const batchDeleteBtn = document.getElementById('batch-delete-btn');
        const batchCancelBtn = document.getElementById('batch-cancel-btn');
        const targetTeamSelect = document.getElementById('target-team-select');
        const confirmBatchMoveBtn = document.getElementById('confirm-batch-move-btn');
        
        // 事件监听
        newCharacterBtn.addEventListener('click', () => {
            editingCharacter = null;
            document.getElementById('character-modal-title').textContent = '新建角色';
            characterModal.style.display = 'flex';
            document.getElementById('character-name').value = '';
        });
        
        newTeamBtn.addEventListener('click', () => {
            editingTeam = null;
            document.getElementById('team-modal-title').textContent = '新建队伍';
            teamModal.style.display = 'flex';
            document.getElementById('team-name').value = '';
        });
        
        clearAllBtn.addEventListener('click', clearAllData);
        
        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                characterModal.style.display = 'none';
                teamModal.style.display = 'none';
                batchMoveModal.style.display = 'none';
            });
        });
        
        characterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (editingCharacter) {
                updateCharacter();
            } else {
                createCharacter();
            }
            characterModal.style.display = 'none';
            characterForm.reset();
            saveToLocalStorage();
        });
        
        teamForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (editingTeam) {
                updateTeam();
            } else {
                createTeam();
            }
            teamModal.style.display = 'none';
            teamForm.reset();
            saveToLocalStorage();
        });
        
        roundInput.addEventListener('change', () => {
            saveToLocalStorage();
        });
        
        addDicePoolBtn.addEventListener('click', addDicePool);
        
        // 批量操作事件监听
        batchModeBtn.addEventListener('click', toggleBatchMode);
        batchCancelBtn.addEventListener('click', cancelBatchMode);
        batchMoveBtn.addEventListener('click', showBatchMoveModal);
        batchDeleteBtn.addEventListener('click', batchDeleteCharacters);
        confirmBatchMoveBtn.addEventListener('click', performBatchMove);
        
        // 创建角色
        function createCharacter() {
            const name = document.getElementById('character-name').value || '实体';
            const speed = parseInt(document.getElementById('character-speed').value) || 0;
            const reason = parseInt(document.getElementById('character-reason').value) || 0;
            const effect = document.getElementById('character-effect').value || '';
            const stamina = parseInt(document.getElementById('character-stamina').value) || 0;
            const hp = parseInt(document.getElementById('character-hp').value) || 0;
            const hpMax = parseInt(document.getElementById('character-hp-max').value) || 0;
            const mp = parseInt(document.getElementById('character-mp').value) || 0;
            const mpMax = parseInt(document.getElementById('character-mp-max').value) || 0;
            const sanity = parseInt(document.getElementById('character-sanity').value) || 0;
            const sanityMax = parseInt(document.getElementById('character-sanity-max').value) || 0;
            const description = document.getElementById('character-description').value || '';
            
            const character = {
                id: `character-${nextCharacterId++}`,
                name,
                speed,
                reason,
                effect,
                stamina,
                hp,
                hpMax,
                mp,
                mpMax,
                sanity,
                sanityMax,
                description,
                lastEdit: Date.now() // 添加最后编辑时间戳
            };
            
            characters.push(character);
            renderCharacter(character, 'team1');
            updateActionBar();
        }
        
        // 更新角色
        function updateCharacter() {
            const id = document.getElementById('character-id').value;
            const name = document.getElementById('character-name').value || '实体';
            const speed = parseInt(document.getElementById('character-speed').value) || 0;
            const reason = parseInt(document.getElementById('character-reason').value) || 0;
            const effect = document.getElementById('character-effect').value || '';
            const stamina = parseInt(document.getElementById('character-stamina').value) || 0;
            const hp = parseInt(document.getElementById('character-hp').value) || 0;
            const hpMax = parseInt(document.getElementById('character-hp-max').value) || 0;
            const mp = parseInt(document.getElementById('character-mp').value) || 0;
            const mpMax = parseInt(document.getElementById('character-mp-max').value) || 0;
            const sanity = parseInt(document.getElementById('character-sanity').value) || 0;
            const sanityMax = parseInt(document.getElementById('character-sanity-max').value) || 0;
            const description = document.getElementById('character-description').value || '';
            
            const characterIndex = characters.findIndex(c => c.id === id);
            if (characterIndex !== -1) {
                characters[characterIndex] = {
                    ...characters[characterIndex],
                    name,
                    speed,
                    reason,
                    effect,
                    stamina,
                    hp,
                    hpMax,
                    mp,
                    mpMax,
                    sanity,
                    sanityMax,
                    description,
                    lastEdit: Date.now() // 更新最后编辑时间戳
                };
                
                // 重新渲染角色
                const characterElement = document.getElementById(id);
                if (characterElement) {
                    characterElement.remove();
                }
                
                // 找到角色所在的队伍
                const team = teams.find(t => t.characters.some(c => c.id === id));
                if (team) {
                    renderCharacter(characters[characterIndex], team.id);
                }
                
                updateActionBar();
            }
        }
        
        // 编辑角色
        function editCharacter(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;
            
            editingCharacter = character;
            document.getElementById('character-modal-title').textContent = '编辑角色';
            
            document.getElementById('character-id').value = character.id;
            document.getElementById('character-name').value = character.name;
            document.getElementById('character-speed').value = character.speed;
            document.getElementById('character-reason').value = character.reason;
            document.getElementById('character-effect').value = character.effect;
            document.getElementById('character-stamina').value = character.stamina || 0;
            document.getElementById('character-hp').value = character.hp;
            document.getElementById('character-hp-max').value = character.hpMax;
            document.getElementById('character-mp').value = character.mp;
            document.getElementById('character-mp-max').value = character.mpMax;
            document.getElementById('character-sanity').value = character.sanity;
            document.getElementById('character-sanity-max').value = character.sanityMax;
            document.getElementById('character-description').value = character.description;
            
            characterModal.style.display = 'flex';
        }
        
        // 删除角色
        function deleteCharacter(characterId) {
            const character = characters.find(c => c.id === characterId);
            if (!character) return;
            
            if (confirm(`确定要删除角色 ${character.name} 吗？`)) {
                // 从所有队伍中移除角色
                teams.forEach(team => {
                    const index = team.characters.findIndex(c => c.id === characterId);
                    if (index !== -1) {
                        team.characters.splice(index, 1);
                    }
                });
                
                // 从角色数组中移除
                const characterIndex = characters.findIndex(c => c.id === characterId);
                if (characterIndex !== -1) {
                    characters.splice(characterIndex, 1);
                }
                
                // 从DOM中移除
                const characterElement = document.getElementById(characterId);
                if (characterElement) {
                    characterElement.remove();
                }
                
                // 如果队伍中没有角色，显示空状态
                teams.forEach(team => {
                    const characterList = document.getElementById(`${team.id}-characters`);
                    if (characterList.children.length === 0 || 
                        (characterList.children.length === 1 && characterList.children[0].classList.contains('empty-state'))) {
                        characterList.innerHTML = '';
                        const emptyState = document.createElement('div');
                        emptyState.className = 'empty-state';
                        emptyState.textContent = '点击下方按钮添加角色';
                        characterList.appendChild(emptyState);
                    }
                });
                
                updateActionBar();
                saveToLocalStorage();
            }
        }
        
        // 渲染角色 - 按照新布局
        function renderCharacter(character, teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            
            // 如果角色已经在其他队伍中，先移除
            teams.forEach(t => {
                const index = t.characters.findIndex(c => c.id === character.id);
                if (index !== -1) {
                    t.characters.splice(index, 1);
                    
                    // 从UI中移除
                    const characterElement = document.getElementById(character.id);
                    if (characterElement) {
                        characterElement.remove();
                    }
                }
            });
            
            team.characters.push(character);
            
            const characterList = document.getElementById(`${teamId}-characters`);
            const emptyState = characterList.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const characterElement = document.createElement('div');
            characterElement.className = 'character';
            characterElement.id = character.id;
            characterElement.setAttribute('data-character-id', character.id);
            
            // 计算百分比
            const totalHp = (character.hpMax || 0) + (character.stamina || 0);
            const hpPercent = totalHp > 0 ? Math.min(100, (character.hp / totalHp) * 100) : 0;
            const staminaPercent = totalHp > 0 ? Math.min(100, ((character.stamina || 0) / totalHp) * 100) : 0;
            const mpPercent = character.mpMax > 0 ? Math.min(100, (character.mp / character.mpMax) * 100) : 0;
            const sanityPercent = character.sanityMax > 0 ? Math.min(100, (character.sanity / character.sanityMax) * 100) : 0;
            
            // 显示血量数字 - 如果有耐久则显示为"血量+耐久"
            const hpDisplay = character.stamina > 0 ? 
                `${character.hp}<span class="stamina-plus">+${character.stamina}</span>` : 
                `${character.hp}`;
            
            // 新的布局
            characterElement.innerHTML = `
                <input type="checkbox" class="character-checkbox" data-character-id="${character.id}">
                <div class="character-top-row">
                    <div class="character-speed">${character.speed}</div>
                    <div class="character-reason">${character.reason}</div>
                </div>
                <div class="character-name">${character.name}</div>
                <div class="character-middle-row">
                    <div class="character-sanity">${character.sanity}</div>
                    <div class="character-hp"><span class="hp-stamina-value">${hpDisplay}</span></div>
                    <div class="character-mp">${character.mp}</div>
                </div>
                <div class="character-bars">
                    <div class="hp-stamina-container">
                        <div class="hp-bar-fill" style="width: ${hpPercent}%"></div>
                        <div class="stamina-bar-fill" style="width: ${staminaPercent}%; left: ${hpPercent}%"></div>
                    </div>
                    <div class="dual-bars">
                        <div class="dual-bar-container">
                            <div class="stat-bar-fill sanity-bar" style="width: ${sanityPercent}%"></div>
                        </div>
                        <div class="dual-bar-container">
                            <div class="stat-bar-fill mp-bar" style="width: ${mpPercent}%"></div>
                        </div>
                    </div>
                </div>
                <div class="character-effect">${character.effect}</div>
            `;
            
            // 添加点击事件显示操作面板
            characterElement.addEventListener('click', (e) => {
                // 防止点击操作面板时触发
                if (!e.target.closest('.character-actions-panel') && !e.target.matches('.character-checkbox')) {
                    if (batchMode) {
                        // 批量模式下切换选择状态
                        toggleCharacterSelection(character.id);
                    } else {
                        showCharacterActions(character.id, characterElement);
                    }
                }
            });
            
            // 添加触摸事件支持长按拖动（仅限移动端）
            if ('ontouchstart' in window) {
                characterElement.addEventListener('touchstart', handleTouchStart);
                characterElement.addEventListener('touchmove', handleTouchMove);
                characterElement.addEventListener('touchend', handleTouchEnd);
            }
            
            // 添加鼠标拖动事件（仅限桌面端，用于拖动）
            characterElement.addEventListener('mousedown', handleMouseDown);
            
            characterList.appendChild(characterElement);
        }
        
        // 创建队伍
        function createTeam() {
            const name = document.getElementById('team-name').value || '队伍3';
            
            const team = {
                id: `team${nextTeamId++}`,
                name,
                characters: []
            };
            
            teams.push(team);
            renderTeam(team);
            saveToLocalStorage();
        }

        // 更新队伍
        function updateTeam() {
            const id = document.getElementById('team-id').value;
            const name = document.getElementById('team-name').value || '队伍';
            
            const teamIndex = teams.findIndex(t => t.id === id);
            if (teamIndex !== -1) {
                teams[teamIndex].name = name;
                
                // 更新UI中的队伍标题
                const teamTitle = document.querySelector(`.team-title[data-team-id="${id}"]`);
                if (teamTitle) {
                    teamTitle.textContent = name;
                }
                
                saveToLocalStorage();
            }
        }

        // 渲染队伍
        function renderTeam(team) {
            const teamsContainer = document.querySelector('.teams-container');
            
            const teamElement = document.createElement('div');
            teamElement.className = 'team';
            teamElement.id = team.id;
            
            teamElement.innerHTML = `
                <div class="team-header">
                    <div class="team-title" data-team-id="${team.id}">${team.name}</div>
                </div>
                <div class="character-list" id="${team.id}-characters">
                    <div class="empty-state">点击下方按钮添加角色</div>
                </div>
            `;
            
            teamsContainer.appendChild(teamElement);
        }

        // 编辑队伍
        function editTeam(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            
            editingTeam = team;
            document.getElementById('team-modal-title').textContent = '编辑队伍';
            
            document.getElementById('team-id').value = team.id;
            document.getElementById('team-name').value = team.name;
            
            teamModal.style.display = 'flex';
        }

        // 删除队伍
        function deleteTeam(teamId) {
            const team = teams.find(t => t.id === teamId);
            if (!team) return;
            
            if (confirm(`确定要删除队伍 ${team.name} 吗？此操作将同时删除队伍中的所有角色！`)) {
                // 从teams数组中移除队伍
                const teamIndex = teams.findIndex(t => t.id === teamId);
                if (teamIndex !== -1) {
                    teams.splice(teamIndex, 1);
                }
                
                // 从DOM中移除队伍
                const teamElement = document.getElementById(teamId);
                if (teamElement) {
                    teamElement.remove();
                }
                
                saveToLocalStorage();
            }
        }
        
        // 显示角色操作面板
        function showCharacterActions(characterId, characterElement) {
            // 隐藏之前打开的面板
            hideActiveCharacterPanel();
            
            // 创建操作面板
            const actionsPanel = document.createElement('div');
            actionsPanel.className = 'character-actions-panel';
            actionsPanel.innerHTML = `
                <button class="edit-character-btn" title="编辑角色">✏️</button>
                <button class="move-character-btn" title="移动角色">⇄</button>
                <button class="delete-character-btn" title="删除角色">🗑️</button>
                <button class="close-panel-btn" title="收起">▲</button>
            `;
            
            // 定位面板
            const rect = characterElement.getBoundingClientRect();
            actionsPanel.style.position = 'absolute';
            actionsPanel.style.top = `${rect.bottom + window.scrollY}px`;
            actionsPanel.style.left = `${rect.left + window.scrollX}px`;
            
            document.body.appendChild(actionsPanel);
            
            // 添加事件监听
            actionsPanel.querySelector('.edit-character-btn').addEventListener('click', () => {
                editCharacter(characterId);
                hideActiveCharacterPanel();
            });
            
            actionsPanel.querySelector('.move-character-btn').addEventListener('click', () => {
                isMovingFromPanel = true;
                startDrag(characterId, characterElement, { clientX: rect.left + rect.width/2, clientY: rect.top + rect.height/2 });
                hideActiveCharacterPanel();
            });
            
            actionsPanel.querySelector('.delete-character-btn').addEventListener('click', () => {
                deleteCharacter(characterId);
                hideActiveCharacterPanel();
            });
            
            actionsPanel.querySelector('.close-panel-btn').addEventListener('click', () => {
                hideActiveCharacterPanel();
            });
            
            // 点击外部关闭面板
            document.addEventListener('click', hideActiveCharacterPanelOnClick, true);
            
            activeCharacterPanel = actionsPanel;
            actionsPanel.style.display = 'flex';
        }
        
        // 隐藏活动角色面板
        function hideActiveCharacterPanel() {
            if (activeCharacterPanel) {
                activeCharacterPanel.remove();
                activeCharacterPanel = null;
                document.removeEventListener('click', hideActiveCharacterPanelOnClick, true);
            }
        }
        
        // 点击外部关闭面板
        function hideActiveCharacterPanelOnClick(e) {
            if (activeCharacterPanel && !activeCharacterPanel.contains(e.target) && 
                !e.target.closest('.character')) {
                hideActiveCharacterPanel();
            }
        }
        
        // 显示移动角色模态框
        function showMoveCharacterModal(characterId) {
            // 填充队伍选择下拉框
            targetTeamSelect.innerHTML = '';
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                targetTeamSelect.appendChild(option);
            });
            
            // 设置当前角色ID
            targetTeamSelect.setAttribute('data-character-id', characterId);
            
            batchMoveModal.style.display = 'flex';
        }
        
        // 更新行动栏 - 优化布局和灰化处理
        function updateActionBar() {
            // 获取所有角色并按速度排序
            const allCharacters = [];
            teams.forEach(team => {
                team.characters.forEach(character => {
                    // 找到角色所属队伍
                    const teamInfo = teams.find(t => t.characters.some(c => c.id === character.id));
                    allCharacters.push({
                        ...character,
                        teamId: teamInfo ? teamInfo.id : 'unknown',
                        teamName: teamInfo ? teamInfo.name : '未知'
                    });
                });
            });
            
            allCharacters.sort((a, b) => {
                if (b.speed !== a.speed) {
                    return b.speed - a.speed;
                }
                // 速度相同时，最后编辑的角色在左侧
                return b.lastEdit - a.lastEdit;
            });
            
            actionBarCharacters.innerHTML = '';
            
            if (allCharacters.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.textContent = '暂无角色';
                actionBarCharacters.appendChild(emptyState);
                return;
            }
            
            allCharacters.forEach(character => {
                const actionCharacter = document.createElement('div');
                actionCharacter.className = 'action-character';
                
                // 对速度小于10的角色进行灰化处理
                if (character.speed < 10) {
                    actionCharacter.classList.add('slow-speed');
                }
                
                // 根据队伍ID设置样式
                const teamClass = character.teamId === 'team1' ? 'team1-indicator' : 'team2-indicator';
                
                // 新的布局：左上角速度，右上角队伍，下方角色名称
                actionCharacter.innerHTML = `
                    <div class="action-character-header">
                        <div class="action-character-speed">${character.speed}</div>
                        <div class="action-character-team ${teamClass}">${character.teamName}</div>
                    </div>
                    <div class="action-character-name">${character.name}</div>
                `;
                
                // 添加点击事件，快速编辑角色
                actionCharacter.addEventListener('click', () => {
                    editCharacter(character.id);
                });
                
                actionBarCharacters.appendChild(actionCharacter);
            });
        }
        
        // 批量操作功能
        function toggleBatchMode() {
            batchMode = !batchMode;
            
            if (batchMode) {
                document.body.classList.add('batch-mode');
                batchControls.classList.add('active');
                batchModeBtn.textContent = '退出批量操作';
                updateBatchSelectionCount();
            } else {
                cancelBatchMode();
            }
        }
        
        function cancelBatchMode() {
            batchMode = false;
            document.body.classList.remove('batch-mode');
            batchControls.classList.remove('active');
            batchModeBtn.textContent = '批量操作';
            selectedCharacters.clear();
            updateBatchSelectionCount();
            
            // 取消所有选中状态
            document.querySelectorAll('.character-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        function toggleCharacterSelection(characterId) {
            if (selectedCharacters.has(characterId)) {
                selectedCharacters.delete(characterId);
            } else {
                selectedCharacters.add(characterId);
            }
            
            // 更新复选框状态
            const checkbox = document.querySelector(`.character-checkbox[data-character-id="${characterId}"]`);
            if (checkbox) {
                checkbox.checked = selectedCharacters.has(characterId);
            }
            
            updateBatchSelectionCount();
        }
        
        function updateBatchSelectionCount() {
            batchSelectionCount.textContent = `已选择 ${selectedCharacters.size} 个角色`;
        }
        
        function showBatchMoveModal() {
            if (selectedCharacters.size === 0) {
                alert('请先选择要移动的角色');
                return;
            }
            
            // 填充队伍选择下拉框
            targetTeamSelect.innerHTML = '';
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                targetTeamSelect.appendChild(option);
            });
            
            batchMoveModal.style.display = 'flex';
        }
        
        function performBatchMove() {
            const targetTeamId = targetTeamSelect.value;
            const targetTeam = teams.find(t => t.id === targetTeamId);
            
            if (!targetTeam) {
                alert('目标队伍不存在');
                return;
            }
            
            selectedCharacters.forEach(characterId => {
                const character = characters.find(c => c.id === characterId);
                if (!character) return;
                
                // 从原队伍中移除
                teams.forEach(team => {
                    const index = team.characters.findIndex(c => c.id === characterId);
                    if (index !== -1) {
                        team.characters.splice(index, 1);
                    }
                });
                
                // 添加到目标队伍
                targetTeam.characters.push(character);
                
                // 更新UI
                const characterElement = document.getElementById(characterId);
                if (characterElement) {
                    characterElement.remove();
                }
                
                const characterList = document.getElementById(`${targetTeamId}-characters`);
                const emptyState = characterList.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                renderCharacter(character, targetTeamId);
            });
            
            updateActionBar();
            cancelBatchMode();
            saveToLocalStorage();
            
            batchMoveModal.style.display = 'none';
            alert(`已将 ${selectedCharacters.size} 个角色移动到 ${targetTeam.name}`);
        }
        
        function batchDeleteCharacters() {
            if (selectedCharacters.size === 0) {
                alert('请先选择要删除的角色');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedCharacters.size} 个角色吗？`)) {
                selectedCharacters.forEach(characterId => {
                    deleteCharacter(characterId);
                });
                
                cancelBatchMode();
            }
        }
        
        // 拖动功能
        function handleTouchStart(e) {
            if (batchMode) return;
            
            const characterElement = e.currentTarget;
            const characterId = characterElement.getAttribute('data-character-id');
            
            // 设置长按计时器
            longPressTimer = setTimeout(() => {
                startDrag(characterId, characterElement, e.touches[0]);
            }, 800); // 800ms长按触发拖动，减少误触
            
            e.preventDefault();
        }
        
        function handleTouchMove(e) {
            if (longPressTimer && dragCharacter) {
                updateDragPosition(e.touches[0]);
                e.preventDefault();
            }
        }
        
        function handleTouchEnd(e) {
            // 清除长按计时器
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            if (dragCharacter) {
                endDrag();
                e.preventDefault();
            }
        }
        
        function handleMouseDown(e) {
            if (batchMode) return;
            
            const characterElement = e.currentTarget;
            const characterId = characterElement.getAttribute('data-character-id');
            
            // 记录初始位置
            const startX = e.clientX;
            const startY = e.clientY;
            
            // 鼠标移动处理函数
            const handleMouseMove = (moveEvent) => {
                const deltaX = Math.abs(moveEvent.clientX - startX);
                const deltaY = Math.abs(moveEvent.clientY - startY);
                
                // 只有当移动距离超过阈值时才启动拖动
                if (deltaX > dragThreshold || deltaY > dragThreshold) {
                    // 移除点击事件，防止触发控制面板
                    characterElement.removeEventListener('click', characterElement.clickHandler);
                    startDrag(characterId, characterElement, moveEvent);
                    document.removeEventListener('mousemove', handleMouseMove);
                }
            };
            
            // 添加鼠标移动事件监听
            document.addEventListener('mousemove', handleMouseMove);
            
            // 添加鼠标释放事件监听
            const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };
            
            document.addEventListener('mouseup', handleMouseUp);
            
            e.preventDefault();
        }
        
        function startDrag(characterId, characterElement, event) {
            dragCharacter = {
                id: characterId,
                element: characterElement,
                originalTeam: findTeamByCharacterId(characterId),
                startX: event.clientX || event.touches[0].clientX,
                startY: event.clientY || event.touches[0].clientY
            };
            
            // 设置拖动样式
            characterElement.classList.add('dragging');
            
            // 设置初始位置
            updateDragPosition(event);
            
            // 添加移动和释放事件监听
            if ('ontouchstart' in window) {
                document.addEventListener('touchmove', handleTouchMoveDocument);
                document.addEventListener('touchend', handleTouchEndDocument);
            } else {
                document.addEventListener('mousemove', handleMouseMoveDocument);
                document.addEventListener('mouseup', handleMouseUpDocument);
            }
        }
        
        function handleTouchMoveDocument(e) {
            if (dragCharacter) {
                updateDragPosition(e.touches[0]);
                e.preventDefault();
            }
        }
        
        function handleTouchEndDocument(e) {
            if (dragCharacter) {
                endDrag();
                e.preventDefault();
            }
            document.removeEventListener('touchmove', handleTouchMoveDocument);
            document.removeEventListener('touchend', handleTouchEndDocument);
        }
        
        function handleMouseMoveDocument(e) {
            if (dragCharacter) {
                updateDragPosition(e);
            }
        }
        
        function handleMouseUpDocument(e) {
            if (dragCharacter) {
                endDrag();
            }
            document.removeEventListener('mousemove', handleMouseMoveDocument);
            document.removeEventListener('mouseup', handleMouseUpDocument);
        }
        
        function updateDragPosition(event) {
            if (!dragCharacter) return;
            
            const characterElement = dragCharacter.element;
            const x = event.clientX || event.touches[0].clientX;
            const y = event.clientY || event.touches[0].clientY;
            
            // 更新元素位置
            characterElement.style.position = 'fixed';
            characterElement.style.zIndex = '10000';
            characterElement.style.left = `${x - characterElement.offsetWidth / 2}px`;
            characterElement.style.top = `${y - characterElement.offsetHeight / 2}px`;
            
            // 检查是否在队伍区域上方
            const teams = document.querySelectorAll('.team');
            let dropTarget = null;
            
            teams.forEach(team => {
                const rect = team.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    dropTarget = team;
                    team.classList.add('drop-target');
                } else {
                    team.classList.remove('drop-target');
                }
            });
            
            dragCharacter.dropTarget = dropTarget;
        }
        
        function endDrag() {
            if (!dragCharacter) return;
            
            const characterElement = dragCharacter.element;
            const characterId = dragCharacter.id;
            const dropTarget = dragCharacter.dropTarget;
            
            // 恢复元素样式
            characterElement.classList.remove('dragging');
            characterElement.style.position = '';
            characterElement.style.zIndex = '';
            characterElement.style.left = '';
            characterElement.style.top = '';
            
            // 移除所有队伍的drop-target样式
            document.querySelectorAll('.team').forEach(team => {
                team.classList.remove('drop-target');
            });
            
            // 如果拖放到了有效的队伍区域
            if (dropTarget && dropTarget.id !== dragCharacter.originalTeam) {
                const targetTeamId = dropTarget.id;
                const character = characters.find(c => c.id === characterId);
                
                if (character) {
                    // 从原队伍中移除
                    teams.forEach(team => {
                        const index = team.characters.findIndex(c => c.id === characterId);
                        if (index !== -1) {
                            team.characters.splice(index, 1);
                        }
                    });
                    
                    // 添加到目标队伍
                    const targetTeam = teams.find(t => t.id === targetTeamId);
                    if (targetTeam) {
                        targetTeam.characters.push(character);
                        
                        // 更新UI
                        characterElement.remove();
                        
                        const characterList = document.getElementById(`${targetTeamId}-characters`);
                        const emptyState = characterList.querySelector('.empty-state');
                        if (emptyState) {
                            emptyState.remove();
                        }
                        
                        renderCharacter(character, targetTeamId);
                        updateActionBar();
                        saveToLocalStorage();
                    }
                }
            }
            
            dragCharacter = null;
            isMovingFromPanel = false;
        }
        
        function findTeamByCharacterId(characterId) {
            for (const team of teams) {
                if (team.characters.some(c => c.id === characterId)) {
                    return team.id;
                }
            }
            return null;
        }
        
        // 骰池功能
        function addDicePool() {
            const poolId = `dice-pool-${Date.now()}`;
            const dicePool = {
                id: poolId,
                type: 'normal', // 'normal', 'sanity', 'expression', 'judgment'
                count: 1,
                min: 1,
                max: 20,
                sanity: 0, // 理智骰池专用
                effect: 'positive', // 正面/负面
                expressionCount: 1, // 解析骰池重复次数
                expression: '1d6', // 解析骰池表达式
                compareValue: 10, // 判断骰池比较值
                note: ''
            };
            
            dicePools.push(dicePool);
            renderDicePool(dicePool);
            saveToLocalStorage();
        }
        
        // 创建骰池元素但不添加到DOM
        function createDicePoolElement(dicePool, noteValue = '') {
            const poolElement = document.createElement('div');
            poolElement.className = 'dice-pool-item';
            poolElement.setAttribute('data-pool-id', dicePool.id); // 添加data-pool-id属性
            
            // 保存备注值
            if (noteValue) {
                dicePool.note = noteValue;
            }
            
            // 骰池头部 - 类型选择、备注、删除按钮
            let headerHTML = `
                <div class="dice-pool-header">
                    <div class="dice-type-selector">
                        <select class="dice-type">
                            <option value="normal" ${dicePool.type === 'normal' ? 'selected' : ''}>常规骰池</option>
                            <option value="sanity" ${dicePool.type === 'sanity' ? 'selected' : ''}>理智骰池</option>
                            <option value="expression" ${dicePool.type === 'expression' ? 'selected' : ''}>解析骰池</option>
                            <option value="judgment" ${dicePool.type === 'judgment' ? 'selected' : ''}>判断骰池</option>
                        </select>
                    </div>
                    <div class="dice-note">
                        <input type="text" class="dice-note-input" placeholder="骰池备注" value="${dicePool.note || ''}">
                    </div>
                    <button class="delete-dice-pool" title="删除骰池">🗑️</button>
                </div>
            `;
            
            // 根据骰池类型渲染不同的控制界面
            let controlsHTML = '';
            
            if (dicePool.type === 'sanity') {
                controlsHTML = `
                    <div class="dice-pool-controls">
                        <div class="dice-control-row">
                            <div class="sanity-effect-selector">
                                <select class="sanity-effect">
                                    <option value="positive" ${dicePool.effect === 'positive' ? 'selected' : ''}>正面</option>
                                    <option value="negative" ${dicePool.effect === 'negative' ? 'selected' : ''}>负面</option>
                                </select>
                            </div>
                            <span>生成</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-count" value="${dicePool.count || 1}" min="1">
                            </div>
                            <span>个从</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-min" value="${dicePool.min || 1}">
                            </div>
                            <span>到</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-max" value="${dicePool.max || 20}">
                            </div>
                            <span>的随机数，理智</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-sanity" value="${dicePool.sanity || 0}" min="-50" max="50">
                            </div>
                            <button class="generate-dice">生成</button>
                        </div>
                    </div>
                `;
            } else if (dicePool.type === 'expression') {
                controlsHTML = `
                    <div class="dice-pool-controls">
                        <div class="dice-control-row">
                            <span>生成</span>
                            <div class="dice-input small">
                                <input type="number" class="expression-count" value="${dicePool.expressionCount || 1}" min="1">
                            </div>
                            <span>#</span>
                            <div class="expression-input">
                                <input type="text" class="dice-expression" value="${dicePool.expression || '1d6'}" placeholder="例如: 2d6+1">
                            </div>
                            <button class="generate-dice">生成</button>
                        </div>
                    </div>
                `;
            } else if (dicePool.type === 'judgment') {
                controlsHTML = `
                    <div class="dice-pool-controls">
                        <div class="dice-control-row">
                            <span>生成</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-count" value="${dicePool.count || 1}" min="1">
                            </div>
                            <span>个从</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-min" value="${dicePool.min || 1}">
                            </div>
                            <span>到</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-max" value="${dicePool.max || 20}">
                            </div>
                            <span>的随机数，与</span>
                            <div class="dice-input small">
                                <input type="number" class="compare-value" value="${dicePool.compareValue || 10}">
                            </div>
                            <span>比较</span>
                            <button class="generate-dice">生成</button>
                        </div>
                    </div>
                `;
            } else {
                controlsHTML = `
                    <div class="dice-pool-controls">
                        <div class="dice-control-row">
                            <span>生成</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-count" value="${dicePool.count || 1}" min="1">
                            </div>
                            <span>个从</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-min" value="${dicePool.min || 1}">
                            </div>
                            <span>到</span>
                            <div class="dice-input small">
                                <input type="number" class="dice-max" value="${dicePool.max || 20}">
                            </div>
                            <span>的随机数</span>
                            <button class="generate-dice">生成</button>
                        </div>
                    </div>
                `;
            }
            
            poolElement.innerHTML = headerHTML + controlsHTML + '<div class="dice-results"></div>';
            
            // 添加事件监听
            setupDicePoolEvents(poolElement, dicePool);
            
            return poolElement;
        }
        
        // 渲染骰池 - 优化后的紧凑布局
        function renderDicePool(dicePool, noteValue = '') {
            const poolElement = createDicePoolElement(dicePool, noteValue);
            dicePoolsContainer.appendChild(poolElement);
        }
        
        // 设置骰池事件监听
        function setupDicePoolEvents(poolElement, dicePool) {
            // 添加事件监听
            const typeSelector = poolElement.querySelector('.dice-type');
            typeSelector.value = dicePool.type;
            typeSelector.addEventListener('change', () => {
                const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                if (poolIndex !== -1) {
                    dicePools[poolIndex].type = typeSelector.value;
                    
                    // 保存当前骰池的位置和状态
                    const currentPosition = Array.from(dicePoolsContainer.children).indexOf(poolElement);
                    const currentNote = poolElement.querySelector('.dice-note-input').value;
                    
                    // 重新渲染骰池，但保持位置
                    poolElement.remove();
                    
                    // 重新渲染骰池到原来的位置
                    if (currentPosition >= 0 && currentPosition < dicePoolsContainer.children.length) {
                        // 插入到原来的位置
                        const nextElement = dicePoolsContainer.children[currentPosition];
                        dicePoolsContainer.insertBefore(createDicePoolElement(dicePools[poolIndex], currentNote), nextElement);
                    } else {
                        // 如果位置无效，添加到末尾
                        renderDicePool(dicePools[poolIndex], currentNote);
                    }
                }
                saveToLocalStorage();
            });
            
            const generateBtn = poolElement.querySelector('.generate-dice');
            generateBtn.addEventListener('click', () => {
                // 使用骰池ID而不是索引
                if (dicePool.type === 'sanity') {
                    generateSanityDicePool(dicePool.id);
                } else if (dicePool.type === 'expression') {
                    generateExpressionDicePool(dicePool.id);
                } else if (dicePool.type === 'judgment') {
                    generateJudgmentDicePool(dicePool.id);
                } else {
                    generateDicePool(dicePool.id);
                }
                // 添加点击反馈
                generateBtn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    generateBtn.style.transform = '';
                }, 100);
            });
            
            const noteInput = poolElement.querySelector('.dice-note-input');
            noteInput.addEventListener('change', () => {
                const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                if (poolIndex !== -1) {
                    dicePools[poolIndex].note = noteInput.value;
                }
                saveToLocalStorage();
            });
            
            // 常规骰池事件
            if (dicePool.type === 'normal' || dicePool.type === 'sanity' || dicePool.type === 'judgment') {
                const countInput = poolElement.querySelector('.dice-count');
                countInput.addEventListener('change', () => {
                    const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                    if (poolIndex !== -1) {
                        dicePools[poolIndex].count = parseInt(countInput.value) || 1;
                    }
                    saveToLocalStorage();
                });
                
                const minInput = poolElement.querySelector('.dice-min');
                minInput.addEventListener('change', () => {
                    const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                    if (poolIndex !== -1) {
                        dicePools[poolIndex].min = parseInt(minInput.value) || 1;
                    }
                    saveToLocalStorage();
                });
                
                const maxInput = poolElement.querySelector('.dice-max');
                maxInput.addEventListener('change', () => {
                    const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                    if (poolIndex !== -1) {
                        dicePools[poolIndex].max = parseInt(maxInput.value) || 20;
                    }
                    saveToLocalStorage();
                });
            }
            
            // 理智骰池专用事件
            if (dicePool.type === 'sanity') {
                const sanityInput = poolElement.querySelector('.dice-sanity');
                sanityInput.addEventListener('change', () => {
                    const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                    if (poolIndex !== -1) {
                        dicePools[poolIndex].sanity = parseInt(sanityInput.value) || 0;
                    }
                    saveToLocalStorage();
                });
                
                const effectSelector = poolElement.querySelector('.sanity-effect');
                effectSelector.value = dicePool.effect || 'positive';
                effectSelector.addEventListener('change', () => {
                    const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                    if (poolIndex !== -1) {
                        dicePools[poolIndex].effect = effectSelector.value;
                    }
                    saveToLocalStorage();
                });
            }
            
            // 解析骰池专用事件
            if (dicePool.type === 'expression') {
                const countInput = poolElement.querySelector('.expression-count');
                countInput.addEventListener('change', () => {
                    const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                    if (poolIndex !== -1) {
                        dicePools[poolIndex].expressionCount = parseInt(countInput.value) || 1;
                    }
                    saveToLocalStorage();
                });
                
                const expressionInput = poolElement.querySelector('.dice-expression');
                expressionInput.addEventListener('change', () => {
                    const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                    if (poolIndex !== -1) {
                        dicePools[poolIndex].expression = expressionInput.value || '1d6';
                    }
                    saveToLocalStorage();
                });
            }
            
            // 判断骰池专用事件
            if (dicePool.type === 'judgment') {
                const compareInput = poolElement.querySelector('.compare-value');
                compareInput.addEventListener('change', () => {
                    const poolIndex = dicePools.findIndex(p => p.id === dicePool.id);
                    if (poolIndex !== -1) {
                        dicePools[poolIndex].compareValue = parseInt(compareInput.value) || 10;
                    }
                    saveToLocalStorage();
                });
            }
            
            const removeBtn = poolElement.querySelector('.delete-dice-pool');
            removeBtn.addEventListener('click', () => {
                dicePools = dicePools.filter(p => p.id !== dicePool.id);
                poolElement.remove();
                saveToLocalStorage();
            });
        }
        
        // 生成常规骰池随机数
        function generateDicePool(poolId) {
            const poolIndex = dicePools.findIndex(p => p.id === poolId);
            if (poolIndex === -1) return;
            
            const dicePool = dicePools[poolIndex];
            // 使用ID查找元素
            const poolElement = document.querySelector(`[data-pool-id="${poolId}"]`);
            if (!poolElement) return;
            
            const resultsElement = poolElement.querySelector('.dice-results');
            
            resultsElement.innerHTML = '';
            
            let results = [];
            for (let i = 0; i < dicePool.count; i++) {
                const randomNum = Math.floor(Math.random() * (dicePool.max - dicePool.min + 1)) + dicePool.min;
                results.push(randomNum);
                const resultElement = document.createElement('div');
                resultElement.className = 'dice-result';
                resultElement.innerHTML = `<span>${randomNum}</span>`;
                resultsElement.appendChild(resultElement);
            }
        }
        
        // 生成理智骰池随机数
        function generateSanityDicePool(poolId) {
            const poolIndex = dicePools.findIndex(p => p.id === poolId);
            if (poolIndex === -1) return;
            
            const dicePool = dicePools[poolIndex];
            // 使用ID查找元素
            const poolElement = document.querySelector(`[data-pool-id="${poolId}"]`);
            if (!poolElement) return;
            
            const resultsElement = poolElement.querySelector('.dice-results');
            
            resultsElement.innerHTML = '';
            
            let results = [];
            for (let i = 0; i < dicePool.count; i++) {
                // 理智骰池算法 - 颠倒逻辑
                const sanityCheck = Math.floor(Math.random() * 100) + 1; // 1-100
                
                // 根据正面/负面选择调整理智值
                const adjustedSanity = dicePool.effect === 'negative' ? -dicePool.sanity : dicePool.sanity;
                const sanityThreshold = adjustedSanity + 50; // 理智+50作为阈值
                
                let randomNum;
                if (sanityCheck > sanityThreshold) {
                    // 当大于阈值时：从最小值到中间值生成小数值
                    const midPoint = Math.floor((dicePool.min + dicePool.max) / 2);
                    randomNum = Math.floor(Math.random() * (midPoint - dicePool.min + 1)) + dicePool.min;
                } else {
                    // 当小于等于阈值时：从中间值到最大值生成大数值
                    const midPoint = Math.floor((dicePool.min + dicePool.max + 1) / 2);
                    randomNum = Math.floor(Math.random() * (dicePool.max - midPoint + 1)) + midPoint;
                }
                
                results.push(randomNum);
                const resultElement = document.createElement('div');
                resultElement.className = 'dice-result';
                
                // 根据结果大小添加样式
                const midPoint = Math.floor((dicePool.min + dicePool.max) / 2);
                if (randomNum > midPoint) {
                    resultElement.classList.add('positive-result');
                } else {
                    resultElement.classList.add('negative-result');
                }
                
                resultElement.innerHTML = `<span>${randomNum}</span>`;
                resultsElement.appendChild(resultElement);
            }
        }
        
        // 生成解析骰池随机数
        function generateExpressionDicePool(poolId) {
            const poolIndex = dicePools.findIndex(p => p.id === poolId);
            if (poolIndex === -1) return;
            
            const dicePool = dicePools[poolIndex];
            // 使用ID查找元素
            const poolElement = document.querySelector(`[data-pool-id="${poolId}"]`);
            if (!poolElement) return;
            
            const resultsElement = poolElement.querySelector('.dice-results');
            
            resultsElement.innerHTML = '';
            
            let results = [];
            for (let i = 0; i < dicePool.expressionCount; i++) {
                try {
                    const result = parseDiceExpression(dicePool.expression);
                    results.push(result);
                    const resultElement = document.createElement('div');
                    resultElement.className = 'dice-result';
                    resultElement.innerHTML = `<span>${result}</span>`;
                    resultsElement.appendChild(resultElement);
                } catch (error) {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'dice-result';
                    resultElement.style.color = 'var(--danger-color)';
                    resultElement.innerHTML = `<span>错误: ${error.message}</span>`;
                    resultsElement.appendChild(resultElement);
                    break;
                }
            }
        }
        
        // 生成判断骰池随机数
        function generateJudgmentDicePool(poolId) {
            const poolIndex = dicePools.findIndex(p => p.id === poolId);
            if (poolIndex === -1) return;
            
            const dicePool = dicePools[poolIndex];
            // 使用ID查找元素
            const poolElement = document.querySelector(`[data-pool-id="${poolId}"]`);
            if (!poolElement) return;
            
            const resultsElement = poolElement.querySelector('.dice-results');
            
            resultsElement.innerHTML = '';
            
            let results = [];
            for (let i = 0; i < dicePool.count; i++) {
                const randomNum = Math.floor(Math.random() * (dicePool.max - dicePool.min + 1)) + dicePool.min;
                results.push(randomNum);
                const resultElement = document.createElement('div');
                resultElement.className = 'dice-result';
                
                // 根据比较结果添加样式
                if (randomNum > dicePool.compareValue) {
                    resultElement.classList.add('greater-result');
                } else if (randomNum < dicePool.compareValue) {
                    resultElement.classList.add('less-result');
                } else {
                    resultElement.classList.add('equal-result');
                }
                
                resultElement.innerHTML = `<span>${randomNum}</span>`;
                resultsElement.appendChild(resultElement);
            }
        }
        
        // 解析骰子表达式
        function parseDiceExpression(expression) {
            // 移除所有空格
            expression = expression.replace(/\s/g, '');
            
            // 检查表达式是否为空
            if (!expression) {
                throw new Error('表达式为空');
            }
            
            // 使用正则表达式匹配骰子表达式
            // 支持格式: XdY, XdY+Z, XdY-Z, dY, dY+Z, dY-Z
            const diceRegex = /^(\d+)?d(\d+)([+-]\d+)?$/i;
            const match = expression.match(diceRegex);
            
            if (!match) {
                throw new Error('无效的骰子表达式');
            }
            
            const count = match[1] ? parseInt(match[1]) : 1;
            const sides = parseInt(match[2]);
            const modifier = match[3] ? parseInt(match[3]) : 0;
            
            // 验证参数
            if (count < 1 || count > 100) {
                throw new Error('骰子数量必须在1-100之间');
            }
            
            if (sides < 1 || sides > 1000) {
                throw new Error('骰子面数必须在1-1000之间');
            }
            
            // 计算骰子结果
            let total = 0;
            for (let i = 0; i < count; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            
            // 应用修正值
            total += modifier;
            
            return total;
        }
        
        // 清除所有数据
        function clearAllData() {
            if (confirm('确定要清除所有数据吗？此操作不可撤销！')) {
                // 重置数据
                teams = [
                    { id: 'team1', name: '友方', characters: [] },
                    { id: 'team2', name: '敌方', characters: [] }
                ];
                characters = [];
                nextCharacterId = 1;
                nextTeamId = 3;
                dicePools = [];
                roundInput.value = 1;
                selectedCharacters.clear();
                batchMode = false;
                
                // 清除DOM
                document.querySelectorAll('.team').forEach(team => {
                    if (team.id !== 'team1' && team.id !== 'team2') {
                        team.remove();
                    }
                });
                
                // 重置默认队伍
                teams.forEach(team => {
                    const characterList = document.getElementById(`${team.id}-characters`);
                    characterList.innerHTML = '';
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.textContent = '点击下方按钮添加角色';
                    characterList.appendChild(emptyState);
                });
                
                // 清除骰池
                dicePoolsContainer.innerHTML = '';
                
                // 清除行动栏
                updateActionBar();
                
                // 清除批量操作状态
                cancelBatchMode();
                
                // 清除本地存储
                localStorage.removeItem('battleRoundViewData');
            }
        }
        
        // 保存到本地存储
        function saveToLocalStorage() {
            const data = {
                teams,
                characters,
                nextCharacterId,
                nextTeamId,
                dicePools,
                round: roundInput.value
            };
            localStorage.setItem('battleRoundViewData', JSON.stringify(data));
        }
        
        // 从本地存储加载
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('battleRoundViewData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                teams = data.teams || [
                    { id: 'team1', name: '友方', characters: [] },
                    { id: 'team2', name: '敌方', characters: [] }
                ];
                characters = data.characters || [];
                nextCharacterId = data.nextCharacterId || 1;
                nextTeamId = data.nextTeamId || 3;
                dicePools = data.dicePools || [];
                roundInput.value = data.round || 1;
                
                // 重新渲染所有队伍
                document.querySelectorAll('.team').forEach(team => {
                    if (team.id !== 'team1' && team.id !== 'team2') {
                        team.remove();
                    }
                });
                
                teams.forEach(team => {
                    if (team.id !== 'team1' && team.id !== 'team2') {
                        renderTeam(team);
                    }
                    
                    // 清空队伍角色列表
                    const characterList = document.getElementById(`${team.id}-characters`);
                    if (characterList) {
                        characterList.innerHTML = '';
                        const emptyState = document.createElement('div');
                        emptyState.className = 'empty-state';
                        emptyState.textContent = '点击下方按钮添加角色';
                        characterList.appendChild(emptyState);
                    }
                });
                
                // 重新渲染所有角色
                characters.forEach(character => {
                    // 找到角色所在的队伍
                    const team = teams.find(t => t.characters.some(c => c.id === character.id));
                    if (team) {
                        renderCharacter(character, team.id);
                    }
                });
                
                // 重新渲染骰池
                dicePoolsContainer.innerHTML = '';
                dicePools.forEach(pool => {
                    renderDicePool(pool);
                });
                
                // 更新行动栏
                updateActionBar();
            }
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            
            // 为团队标题添加点击事件，用于编辑队伍
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('team-title')) {
                    const teamId = e.target.getAttribute('data-team-id');
                    // 只允许编辑自定义队伍，不允许编辑默认队伍
                    if (teamId !== 'team1' && teamId !== 'team2') {
                        editTeam(teamId);
                    }
                }
            });
        });
    </script>
</body>
</html>