<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EoM战斗面板编辑器</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .battle-panel {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #444;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
        .control-panel {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #444;
            margin-bottom: 20px;
        }
        .tools-panel {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .round-line {
            color: #ffcc00;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .team {
            margin-bottom: 15px;
        }
        .team-name {
            font-weight: bold;
            color: #4da6ff;
            margin-bottom: 5px;
        }
        .character {
            margin-bottom: 10px;
            padding-left: 20px;
        }
        .character-line1 {
            margin-bottom: 3px;
        }
        .character-line2 {
            margin-bottom: 3px;
            padding-left: 4px;
        }
        .character-diy {
            color: #777;
            font-style: italic;
            padding-left: 4px;
            margin-bottom: 5px;
        }
        .editable {
            background-color: #333;
            border: 1px dashed #555;
            padding: 2px 5px;
            min-width: 50px;
            display: inline-block;
        }
        .optional {
            background-color: #333;
            border: 1px dashed #777;
            padding: 2px 5px;
            min-width: 50px;
            display: inline-block;
            color: #aaa;
        }
        button {
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #5a5a5a;
        }
        .tool-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .tool-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffcc00;
        }
        .calculator {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .calculator-input {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px;
            font-family: 'Courier New', monospace;
            width: 100%;
        }
        .dice-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .dice-inputs input {
            width: 60px;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 5px;
        }
        .result-display {
            background-color: #333;
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
        }
        select {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 5px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="battle-panel" id="battle-display">
            <div class="round-line">===== 第<span class="editable" contenteditable="true">1</span>轮 =====</div>
            
            <div class="team" id="team-friend">
                <div class="team-name">友方</div>
                <!-- 角色将通过JavaScript动态添加 -->
            </div>
            
            <div class="team" id="team-enemy">
                <div class="team-name">敌方</div>
                <!-- 角色将通过JavaScript动态添加 -->
            </div>
            
            <div class="round-line">===== <span class="editable" contenteditable="true">角色名</span> 的回合 =====</div>
        </div>

        <div class="control-panel">
            <h3>角色管理</h3>
            <div>
                <select id="char-team-select">
                    <option value="friend">友方</option>
                    <option value="enemy">敌方</option>
                    <option value="bench">台下</option>
                </select>
                <button id="add-character">添加角色</button>
                <button id="remove-character">移除角色</button>
                <button id="move-character">移动角色</button>
            </div>
            <div style="margin-top: 10px;">
                <button id="copy-display">复制战斗盘内容</button>
            </div>
        </div>

        <div class="tools-panel">
            <div class="tool-section">
                <div class="tool-title">骰子模拟器</div>
                <div class="dice-inputs">
                    <span>生成</span>
                    <input type="number" id="dice-times" min="1" max="20" value="1">
                    <span>个</span>
                    <input type="number" id="dice-min" min="0" max="999" value="1">
                    <span>到</span>
                    <input type="number" id="dice-max" min="1" max="1000" value="6">
                    <span>的随机数</span>
                </div>
                <button id="roll-dice">掷骰</button>
                <div class="result-display" id="dice-result"></div>
            </div>
            
            <div class="tool-section">
                <div class="tool-title">表达式计算器</div>
                <div class="calculator">
                    <input type="text" class="calculator-input" id="calc-input" placeholder="输入数学表达式，如: 3*(2+4)/2">
                    <button id="calculate">计算</button>
                    <div class="result-display" id="calc-result"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 角色计数器
        let characterId = 0;
        
        // 初始化两个队伍
        const teams = {
            friend: document.getElementById('team-friend'),
            enemy: document.getElementById('team-enemy'),
            bench: [] // 台下角色不显示
        };
        
        // 添加角色
        document.getElementById('add-character').addEventListener('click', function() {
            const teamSelect = document.getElementById('char-team-select');
            const team = teamSelect.value;
            const character = createCharacter();
            
            if (team === 'bench') {
                teams.bench.push(character);
            } else {
                teams[team].appendChild(character);
            }
        });
        
        // 移除角色
        document.getElementById('remove-character').addEventListener('click', function() {
            const teamSelect = document.getElementById('char-team-select');
            const team = teamSelect.value;
            
            if (team === 'bench') {
                if (teams.bench.length > 0) {
                    teams.bench.pop();
                }
            } else {
                const teamElement = teams[team];
                if (teamElement.children.length > 1) { // 保留team-name
                    teamElement.removeChild(teamElement.lastChild);
                }
            }
        });
        
        // 移动角色
        document.getElementById('move-character').addEventListener('click', function() {
            // 简化实现：将最后一个角色移动到另一个队伍
            const teamSelect = document.getElementById('char-team-select');
            const team = teamSelect.value;
            
            if (team === 'bench') {
                // 从台上移动到台下
                for (const t of ['friend', 'enemy']) {
                    const teamElement = teams[t];
                    if (teamElement.children.length > 1) {
                        const character = teamElement.lastChild;
                        teamElement.removeChild(character);
                        teams.bench.push(character);
                        break;
                    }
                }
            } else {
                // 从台下移动到台上或队伍间移动
                if (teams.bench.length > 0) {
                    const character = teams.bench.pop();
                    teams[team].appendChild(character);
                } else {
                    // 没有台下角色，尝试从另一个队伍移动
                    const otherTeam = team === 'friend' ? 'enemy' : 'friend';
                    const otherTeamElement = teams[otherTeam];
                    if (otherTeamElement.children.length > 1) {
                        const character = otherTeamElement.lastChild;
                        otherTeamElement.removeChild(character);
                        teams[team].appendChild(character);
                    }
                }
            }
        });
        
        // 创建新角色元素
        function createCharacter() {
            characterId++;
            const characterDiv = document.createElement('div');
            characterDiv.className = 'character';
            characterDiv.dataset.id = characterId;
            
            characterDiv.innerHTML = `
                <div class="character-line1">
                    <span class="editable" contenteditable="true">CP</span> 
                    <span class="editable" contenteditable="true">角色${characterId}</span> 
                    <span class="editable" contenteditable="true">效果</span>
                </div>
                <div class="character-line2">
                    <span class="editable" contenteditable="true">100.00/100.00</span> 
                    <span class="editable" contenteditable="true">50.00/50.00</span> 
                    <span class="editable" contenteditable="true">30.00/30.00</span>
                </div>
                <div class="character-diy" contenteditable="true">备注内容</div>
            `;
            
            return characterDiv;
        }
        
        // 复制战斗盘内容
        document.getElementById('copy-display').addEventListener('click', function() {
            const display = document.getElementById('battle-display');
            let textToCopy = '';
            
            // 遍历所有子节点
            for (const child of display.children) {
                if (child.classList.contains('round-line')) {
                    textToCopy += child.textContent + '\n';
                } else if (child.classList.contains('team')) {
                    // 跳过team-name
                    for (let i = 1; i < child.children.length; i++) {
                        const charElement = child.children[i];
                        // 只复制前两行，跳过diy文本
                        textToCopy += charElement.children[0].textContent + '\n';
                        textToCopy += charElement.children[1].textContent + '\n';
                    }
                    // 队伍间空一行
                    textToCopy += '\n';
                }
            }
            
            // 移除最后一个多余的空行
            textToCopy = textToCopy.trimEnd();
            
            navigator.clipboard.writeText(textToCopy).then(function() {
                alert('战斗盘内容已复制到剪贴板！');
            }, function() {
                // 如果剪贴板API不可用，使用备用方法
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('战斗盘内容已复制到剪贴板！');
            });
        });
        
        // 骰子模拟器
        document.getElementById('roll-dice').addEventListener('click', function() {
            const times = parseInt(document.getElementById('dice-times').value) || 1;
            const min = parseInt(document.getElementById('dice-min').value) || 1;
            const max = parseInt(document.getElementById('dice-max').value) || 6;
            
            if (min > max) {
                document.getElementById('dice-result').textContent = '错误：最小值不能大于最大值';
                return;
            }
            
            let results = [];
            for (let i = 0; i < times; i++) {
                results.push(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            
            let resultText = `结果: ${results.join(', ')}`;
            if (times > 1) {
                const sum = results.reduce((a, b) => a + b, 0);
                const avg = sum / times;
                resultText += `\n总和: ${sum}  平均值: ${avg.toFixed(2)}`;
            }
            
            document.getElementById('dice-result').textContent = resultText;
        });
        
        // 表达式计算器
        document.getElementById('calculate').addEventListener('click', function() {
            try {
                const input = document.getElementById('calc-input').value;
                // 安全评估表达式
                const result = evaluateExpression(input);
                document.getElementById('calc-result').textContent = `= ${result}`;
            } catch (e) {
                document.getElementById('calc-result').textContent = '错误: 无效的表达式';
            }
        });
        
        // 安全评估数学表达式
        function evaluateExpression(expr) {
            // 移除所有非数学表达式字符
            const safeExpr = expr.replace(/[^-()\d/*+.]/g, '');
            // 使用Function构造器而不是eval
            return new Function(`return ${safeExpr}`)();
        }
        
        // 初始化两个角色
        teams.friend.appendChild(createCharacter());
        teams.enemy.appendChild(createCharacter());
    </script>
</body>
</html>